<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>벌금 게시판</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
  <style type="text/css">
    a:link { color: red; text-decoration: none;}
    a:visited { color: black; text-decoration: none;}
    a:hover { color: blue; text-decoration: underline;}
    .adad{
      width: 100%;
      display: flex;
      justify-content: center;
    }
   </style>
     <link rel="stylesheet" href="style.css">

</head>
<body style='font-family: "Do Hyeon", sans-serif;'>
  <script src="main.js" ></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
  
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">벌금 게시판</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list hamburgar" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
        </svg>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="login1.html">로그인</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">회원가입</a>
          </li>
          <li>
            <a class="nav-link" id="logout">로그아웃</a>

            <!-- <button id="logout" type="button" class=" btn btn-dark second">로그아웃</button> -->
          </li>
        </ul>
        
      </div>
    </div>
  </nav>

  <div class="adad mt-5">
    <h1 class="admin">관리자:&nbsp;</h1>
    <h1 class="username">로그인 안됨</h1>
  </div>

  <div class="container mt-5 mb-2">
    <div class="footer">
      <a href="index.html"><h4 class="first">벌금 게시판</h4></a>
      <button  type="button" class=" btn btn-dark download" id="downlaod">다운로드</button>
      
      <button id="upload" type="button" class=" btn btn-dark second">업로드</button>
      
    </div>

    <div class="mt-1 mb-1" style="display: flex;">
      <h2>총금액:&nbsp;</h2>
      <h2 style="color: red;" class="totalprice"></h1>
      <h2>원</h2>
    </div>

    <table class="halo" id="posts" style="text-align: center; border: 2px solid #000;">
      <tr style="font-size: 1.2rem;">
        <th style="font-weight: bold; width: 200px;">이름 </th>
        <th style="font-weight: bold; width: 300px;">날짜 </th>
        <th style="font-weight: bold; width: 150px;">시간 </th>
        <th style="font-weight: bold; width: 800px;">사유 </th>
        <th style="font-weight: bold; width: 150px;">금액 </th>
        <th style="font-weight: bold; width: 200px;">작성자 </th>
        <th style="font-weight: bold; width: 100px; font-size: 1rem;">본인확인</th>
      
    </table>
    <button onclick='location.href="total.html"' type="button" class=" btn btn-dark second mt-3">개인 페이지</button>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> 

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyAPuLYEvXybAM2Nkj8s7AN60Hcg6dSvaxI",
      authDomain: "dshsfine.firebaseapp.com",
      projectId: "dshsfine",
      storageBucket: "dshsfine.appspot.com",
      messagingSenderId: "932376056646",
      appId: "1:932376056646:web:3d47f1dd8fcd14ded88b47",
      measurementId: "G-G3GH2MWHBG"
    };
    
    

    firebase.initializeApp(firebaseConfig);

    username = ""
    firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    $('.username').html(user.email.substring(0,3))
  } else {
    // 로그인된 사용자가 없는 경우
    console.log("No user is logged in.");
  }
});

  

    let a = ""
    firebase.auth().onAuthStateChanged((user)=>{
          if(user){
            console.log(user.uid)
            console.log(user.displayName)
            $('#userName').html(user.displayName)
            a = "yes"
          }else{
            a = 'no';
            console.log(a)
          }
      })
      document.getElementById('upload').addEventListener('click', function() {
        if (a === "no") {
          alert("로그인되지 않았습니다.");
        }else{
          location.href ='upload.html'
        }
      });

      $("#logout").click(function(){

firebase.auth().signOut().then(function() {
        //alert("로그아웃 되었습니다")
        //메인 페이지로 이동시키고 세션 저장시키기
        window.location.href = "/index.html"
        
}).catch(function(error) {
if(error){
        alert("로그인 실패");
}
});
});



    const excelDownload = document.querySelector('#downlaod');

document.addEventListener('DOMContentLoaded', ()=>{
    excelDownload.addEventListener('click', exportExcel);
});

function exportExcel(){ 
//엑셀 시트 생성
  var wb = XLSX.utils.book_new();
  var newSh = excelHandler.getWorksheet();
  XLSX.utils.book_append_sheet(wb, newSh, excelHandler.getSheetName());
  var wb = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});

  saveAs(new Blob([stab(wb)],{type:"application/octet-stream"}), excelHandler.getExcelFileName());
}

var excelHandler = {
    getExcelFileName : function(){
        return '1학년9반 벌금 현황.xlsx';	//파일 이름
    },
    getSheetName : function(){
        return '시트 이름';	//시트 이름
    },
    getExcelData : function(){
        return document.getElementById('posts'); 	//TABLE id
    },
    getWorksheet : function(){
        return XLSX.utils.table_to_sheet(this.getExcelData());
    }
}

function stab(s) { 
  var buf = new ArrayBuffer(s.length); //convert s to arrayBuffer
  var view = new Uint8Array(buf);  //create uint8array as viewer
  for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; //convert to octet
  return buf;    
}
  
    let totalprice = 0
    const db = firebase.firestore();
    db.collection('fine').orderBy('timestamp', 'asc').get().then((결과)=>{
      결과.forEach((doc)=>{
        const data = doc.data();
        totalprice = totalprice+ parseInt(doc.data().총시간)
        $('.totalprice').html(totalprice*1000)
    // 날짜 필드를 Firebase Timestamp 객체로 변환 (필요 시)
    const timestamp = data.timestamp;
    let formattedDate = '';

    if (timestamp instanceof firebase.firestore.Timestamp) {
      const date = timestamp.toDate();
      const year = date.getFullYear().toString().slice(-2); // 'YY'
      const month = ('0' + (date.getMonth() + 1)).slice(-2); // 'MM' (월은 0부터 시작하므로 +1)
      const day = ('0' + date.getDate()).slice(-2); // 'DD'
      formattedDate = `${year}-${month}-${day}`;
    } else {
      // timestamp가 Unix Epoch 시간(밀리초)일 경우 처리
      const date = new Date(timestamp);
      const year = date.getFullYear().toString().slice(-2); // 'YY'
      const month = ('0' + (date.getMonth() + 1)).slice(-2); // 'MM' (월은 0부터 시작하므로 +1)
      const day = ('0' + date.getDate()).slice(-2); // 'DD'
      formattedDate = `${year}-${month}-${day}`;
    }
    if(data.본인확인 == "on"){
      texttext = `<input type="checkbox" checked disabled>`
    }else{
      texttext = `<input type="checkbox" >`
    }

        console.log(doc)
        var templates = `<tr class="content" style="height: 35px; font-size: 1.1rem;">
        <td>${doc.data().이름}</td>
        <td>${doc.data().날짜}</td>
        <td>${doc.data().총시간}분</td>
        <td>${doc.data().지각사유}</td>
        <td>${doc.data().총시간 * 1000}원</td>
        <td>${doc.data().쓴사람이름}</td>
        <td>${texttext}</td>
        </tr>`;
        $('.halo').append(templates)
      })
    })

</script>
</body>
</html>